<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"> <head> <link href="http://gmpg.org/xfn/11" rel="profile"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"> <link rel="manifest" href="/site.webmanifest"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <title> Privacy and Exposure, Gatekeepers and Privileged Consumers &middot; effluence </title> <link rel="stylesheet" href="/css/poole.css"> <link rel="stylesheet" href="/css/syntax.css"> <link rel="stylesheet" href="/css/hyde.css"> <link rel="stylesheet" href="/css/custom.css"> <link rel="preconnect" href="https://fonts.gstatic.com"> <link href="https://fonts.googleapis.com/css2?family=Epilogue&display=swap" rel="stylesheet"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> </head> <body class="layout-reverse"> <div class="sidebar"> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1>effluence</h1> <p class="lead"></p> </div> <ul class="sidebar-nav"> <li class="sidebar-nav-item"> <a href="/">home</a> </li> <li class="sidebar-nav-item"> <a href="/about/">about</a> </li> <li class="sidebar-nav-item"> <a href="/atom.xml" target="_blank">rss</a> </li> </ul> <p>&copy; 2021. All rights reserved.</p> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">Privacy and Exposure, Gatekeepers and Privileged Consumers</h1> <h2>Encapsulation and Information Hiding</h2> <p><span class="fancylink"> <a href="https://en.wikipedia.org/wiki/Information_hiding">Encapsulation</a> <span> <a href="https://en.wikipedia.org/wiki/Information_hiding" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span> and <span class="fancylink"> <a href="https://en.wikipedia.org/wiki/Information_hiding">information hiding</a> <span> <a href="https://en.wikipedia.org/wiki/Information_hiding" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>, are well known principles in object-oriented programming, common mechanisms for maintaining DRY code and enforcing the <span class="fancylink"> <a href="https://en.wikipedia.org/wiki/Single_responsibility_principle">single responsibility principle</a> <span> <a href="https://en.wikipedia.org/wiki/Single_responsibility_principle" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>. While these foundational elements imbue the programmer with significant expressive power and are essential for writing software with possessing anything more than a semblance of maintainability, they sometimes introduce restrictions that are ultimately antithetical to those goals. We, the writers of code, should, therefore, have a solid understanding of not only the standard use of these core object-oriented principles, but also, and, perhaps, more importantly, where they break down in addition to how and when to work around them.</p> <p>We will look at the ways in which we are able to subvert typical safety nets, and this exploration of various means for exposing otherwise private members will also serve as an introduction to some features of the Ruby programming language less frequently encountered in day to day practice. We will, ultimately, introduce additional safety to objects that traditionally have little, in an attempt to limit the use of our newfound powers for good. Let us begin by looking at the three levels of visibility available and how they are used via a concrete, storybook example.</p> <h2>Visibility or Protection</h2> <p>Ruby has three different levels of visibility, the two most common of which are <code>public</code> and <code>private</code>. Public members, as the name implies, are unequivocally accessible to any and all callers. Private members, on the other hand, much like Penelope, have extremely restricted access, described in the official documentation <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/doc/syntax/modules_and_classes_rdoc.html#label-Visibility">section on visibility</a> <span> <a href="https://ruby-doc.org/core-2.5.0/doc/syntax/modules_and_classes_rdoc.html#label-Visibility" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span> as:</p> <blockquote> <p> The third visibility is <code>private</code>. A private method may not be called with a receiver, not even <code>self</code>. If a private method is called with a receiver a NoMethodError will be raised. </p> </blockquote> <p>While not necessarily clear from that description, what this means is that private members are only available in any context where they can be accessed without a receiver, specifically in an instance of a class or any of its subclasses. A <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/doc/syntax/calling_methods_rdoc.html#label-Receiver">separate document</a> <span> <a href="https://ruby-doc.org/core-2.5.0/doc/syntax/calling_methods_rdoc.html#label-Receiver" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span> explains explicit receivers: in summary, as long as the dot syntax is not required, a private method may be called.</p> <p>What is strange about private access in Ruby is its similarity to protected access in most other object-oriented languages (e.g. C++, Java, C#), yet Ruby also has protected members. This leads to the question of what exactly that means, and, fortunately, we can fall back on the official documentation.</p> <blockquote> <p> The second visibility is <code>protected</code>. When calling a protected method the sender must be a subclass of the receiver or the receiver must be a subclass of the sender. Otherwise a NoMethodError will be raised. </p> <p> Protected visibility is most frequently used to define <code>==</code> and other comparison methods where the author does not wish to expose an object's state to any caller and would like to restrict it only to inherited classes. </p> </blockquote> <p>That definition, and its accompanying example, are opaque enough that that it warrants looking at a simplified example. Imagine we have two kinds of <code>Mammal</code>, <code>Kitten</code>s and <code>Puppy</code>s, both of which are capable of <code>cuddle</code>ing. In this sad scenario, however, affection between species is nonexistent, so kittens and puppies will never cuddle with each other. This can be accomplished with the use of protected methods.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">Mammal</span>
  <span class="k">def</span> <span class="nf">cuddle</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="o">[</span><span class="n">reaction</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">reaction</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Kitten</span> <span class="o">&lt;</span> <span class="no">Mammal</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">reaction</span>
    <span class="ss">:purr</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Puppy</span> <span class="o">&lt;</span> <span class="no">Mammal</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">reaction</span>
    <span class="ss">:nuzzle</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <figure class="highlight"><pre><code class="language-irb" data-lang="irb"><span></span><span class="gp">&gt;&gt; </span><span class="n">gweeby</span><span class="p">,</span> <span class="n">luxe</span><span class="p">,</span> <span class="n">bella</span> <span class="o">=</span> <span class="no">Kitten</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="no">Kitten</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="no">Puppy</span><span class="o">.</span><span class="n">new</span>
<span class="gp">&gt;&gt; </span><span class="n">gweeby</span><span class="o">.</span><span class="n">cuddle</span><span class="p">(</span><span class="n">luxe</span><span class="p">)</span>
<span class="go">=&gt; [:purr, :purr]</span>

<span class="gp">&gt;&gt; </span><span class="n">gweeby</span><span class="o">.</span><span class="n">cuddle</span><span class="p">(</span><span class="n">bella</span><span class="p">)</span>
<span class="go">NoMethodError: protected method `reaction&#39; called for #&lt;Puppy:0x00005581ee417790&gt;</span></code></pre></figure> <p>As you can see, our two kittens, Gweeby and Luxe, will happily share their warmth, but Bella is disallowed from partaking. To put protected access in plain English, it allows different instances of the same class (including superclasses) to access methods on each other. In this example, both instances of <code>Kitten</code> can call <code>reaction</code> on each other, but not on an instance of <code>Puppy</code>.</p> <h2>Ancestry or Injection</h2> <p>In a world more worth living in, while the animosity between dogs and cats may yet persist generally, but there can also be exceptions to the rule, such as when particular animals grew up in close proximity. At this point, we will look at how we can exploit the fact that Ruby violates the <span class="fancylink"> <a href="https://en.wikipedia.org/wiki/Open/closed_principle">open/closed principle</a> <span> <a href="https://en.wikipedia.org/wiki/Open/closed_principle" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span> in order to realize this possibility.</p> <p>The obvious approach, for many seasoned Ruby developers, would be to simply fall back on the facilities Ruby provides for accessing non-public members, namely the functionally equivalent approaches of <code>instance_eval</code> and <code>send</code>.</p> <figure class="highlight"><pre><code class="language-irb" data-lang="irb"><span></span><span class="gp">&gt;&gt; </span><span class="n">bella</span><span class="o">.</span><span class="n">instance_eval</span> <span class="p">{</span> <span class="n">reaction</span> <span class="p">}</span>
<span class="go">=&gt; :nuzzle</span>

<span class="gp">&gt;&gt; </span><span class="n">bella</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:reaction</span><span class="p">)</span>
<span class="go">=&gt; :nuzzle</span></code></pre></figure> <p>While these approaches may be Good Enough™, we can do better by utilizing the class ancestry of our kittens and puppies. Inspecting the output from <span class="fancylink"> <a href="https://ruby-doc.org/core-2.1.0/Module.html#method-i-ancestors"><code>Module#ancestors</code></a> <span> <a href="https://ruby-doc.org/core-2.1.0/Module.html#method-i-ancestors" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>, we can see that our two classes, as expected, are nearly identical.</p> <figure class="highlight"><pre><code class="language-irb" data-lang="irb"><span></span><span class="gp">&gt;&gt; </span><span class="no">Kitten</span><span class="o">.</span><span class="n">ancestors</span>
<span class="go">=&gt; [Kitten, Mammal, Object, Kernel, BasicObject]</span>

<span class="gp">&gt;&gt; </span><span class="no">Puppy</span><span class="o">.</span><span class="n">ancestors</span>
<span class="go">=&gt; [Puppy, Mammal, Object, Kernel, BasicObject]</span>

<span class="gp">&gt;&gt; </span><span class="no">Kitten</span><span class="o">.</span><span class="n">ancestors</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="no">Puppy</span><span class="o">.</span><span class="n">ancestors</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">=&gt; true</span></code></pre></figure> <p>Including a module on a class will actually modify the ancestors of that class, thereby affecting the path of method lookup. For example, if we open the <code>Puppy</code> class using <code>class_eval</code>, we can include an anonymous module, that subsequently appears in the list of ancestors.</p> <figure class="highlight"><pre><code class="language-irb" data-lang="irb"><span></span><span class="gp">&gt;&gt; </span><span class="no">Puppy</span><span class="o">.</span><span class="n">class_eval</span> <span class="p">{</span> <span class="kp">include</span> <span class="no">Module</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span>
<span class="gp">&gt;&gt; </span><span class="no">Puppy</span><span class="o">.</span><span class="n">ancestors</span>
<span class="go">=&gt; [Puppy, #&lt;Module:0x000055c94e207ca0&gt;, Mammal, Object, Kernel, BasicObject]</span></code></pre></figure> <p>This little bit of knowledge is not particularly useful by itself, since the method lookup will stop at the <code>Puppy</code> class, where the <code>reaction</code> method is still protected. This can be more easily visualized by stating that our classes for kitten and puppies are leafs in the object tree, which can only be extended through subclassing, which is not desirable in this instance. Were only there some way to inject an module before the class in which our protected method is defined. Enter the <span class="fancylink"> <a href="https://ruby-doc.org/core-2.1.0/doc/syntax/modules_and_classes_rdoc.html#label-Singleton+Classes">singleton class</a> <span> <a href="https://ruby-doc.org/core-2.1.0/doc/syntax/modules_and_classes_rdoc.html#label-Singleton+Classes" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>. A singleton class is a special, unique class that exists for each object. The easiest way, perhaps, to demonstrate how it operates is to again turn to our class ancestry, but, this time, by using <span class="fancylink"> <a href="https://ruby-doc.org/core-2.1.0/Object.html#method-i-singleton_class"><code>Object#singleton_class</code></a> <span> <a href="https://ruby-doc.org/core-2.1.0/Object.html#method-i-singleton_class" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span> method.</p> <figure class="highlight"><pre><code class="language-irb" data-lang="irb"><span></span><span class="gp">&gt;&gt; </span><span class="n">gweeby</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">ancestors</span>
<span class="go">=&gt; [#&lt;Class:#&lt;Kitten:0x000055f164658910&gt;&gt;, Kitten, Mammal, Object, Kernel, BasicObject]</span>

<span class="gp">&gt;&gt; </span><span class="n">bella</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">ancestors</span>
<span class="go">=&gt; [#&lt;Class:#&lt;Puppy:0x00005581ee417790&gt;&gt;, Puppy, Litter, Mammal, Object, Kernel, BasicObject]</span></code></pre></figure> <p>Now we can see a point of inflection where we can potentially inject a shared ancestor that will act as a <strong>gatekeeper</strong> of sorts; for example, consider the following module, called <code>Litter</code> to denote that mammals including it have had close familial relations since an early age.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Litter</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">reaction</span>
    <span class="k">super</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>As is clear, this module does nothing other than proxy the call to <code>reaction</code>, but, combined with the ability to open the singleton class, this gives us the incredible ability to open protected methods to instances of certain other objects as we see fit. We can see, in the following example, that Gweeby and Bella will cuddle, based on their being part of the same litter, while Luxe and Bella will not.</p> <figure class="highlight"><pre><code class="language-irb" data-lang="irb"><span></span><span class="gp">&gt;&gt; </span><span class="n">gweeby</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">class_eval</span> <span class="p">{</span> <span class="kp">include</span> <span class="no">Litter</span> <span class="p">}</span>
<span class="gp">&gt;&gt; </span><span class="n">bella</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">class_eval</span> <span class="p">{</span> <span class="kp">include</span> <span class="no">Litter</span> <span class="p">}</span>

<span class="gp">&gt;&gt; </span><span class="n">gweeby</span><span class="o">.</span><span class="n">cuddle</span><span class="p">(</span><span class="n">bella</span><span class="p">)</span>
<span class="go">=&gt; [:purr, :nuzzle]</span>

<span class="gp">&gt;&gt; </span><span class="n">luxe</span><span class="o">.</span><span class="n">cuddle</span><span class="p">(</span><span class="n">bella</span><span class="p">)</span>
<span class="go">NoMethodError: protected method `reaction&#39; called for #&lt;Puppy:0x00005581ee417790&gt;</span></code></pre></figure> <h2>Asymmetry or Refinement</h2> <p>We now have the means of exposing methods between two collaborating objects that share an interface, in this case, the <code>#reaction</code> method. Let us imagine a world where kittens refuse to be cuddled unless they are the instigator in the interaction. Our injected gatekeepers cannot accommodate this asymmetrical relationship; we will need to use a different means of exposing our protected methods. Here, we can make use of a language feature first introduced in Ruby 2.0, the <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/doc/syntax/refinements_rdoc.html">refinement</a> <span> <a href="https://ruby-doc.org/core-2.5.0/doc/syntax/refinements_rdoc.html" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>.</p> <p>This seldom used feature gives up the ability to change class definitions within the local context, rather than globally like a typical monkey patch. The particular rules for this locality are fairly complicated, but, most importantly, the refined class is modified from the point at which the refined module is used, to the end of the block or file. The following example shows how we can <code>refine</code> the <code>Puppy</code> class to make its <code>reaction</code> method available in a <code>Kitten</code> instance.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">Puppy</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">reaction</span>
    <span class="ss">:nuzzle</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">Instigator</span>
  <span class="n">refine</span> <span class="no">Puppy</span> <span class="k">do</span>
    <span class="kp">public</span> <span class="ss">:reaction</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Kitten</span>
  <span class="n">using</span> <span class="no">Instigator</span>

  <span class="k">def</span> <span class="nf">cuddle</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="o">[</span><span class="n">reaction</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">reaction</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">reaction</span>
    <span class="ss">:purr</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <figure class="highlight"><pre><code class="language-irb" data-lang="irb"><span></span><span class="gp">&gt;&gt; </span><span class="no">Kitten</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">cuddle</span><span class="p">(</span><span class="no">Puppy</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
<span class="go">=&gt; [:purr, :nuzzle]</span></code></pre></figure> <p>Now we have what may be termed a <strong>privileged consumer</strong>. The <code>Kitten</code> class may instigate interactions with the <code>Puppy</code> class, but no other object may do the same. This leads to some interesting consequences when we make use of these intricacies in a more practical example.</p> <h2>To Redact an Interface</h2> <p>This tale of mammalian intrigue has, thus far, provided us with an avenue for the exploration of the building blocks of member access in Ruby, but, as yet, has made no stride toward convincing us that this approach can be useful in the real world. Let us, then, consider a typical Rails application, with heavy use of ActiveRecord throughout. Much of this is inspired by the book <span class="fancylink"> <a href="http://objectsonrails.com/">Objects on Rails</a> <span> <a href="http://objectsonrails.com/" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>, by <span class="fancylink"> <a href="http://www.virtuouscode.com/">Avdi Grimm</a> <span> <a href="http://www.virtuouscode.com/" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>. Therein, Grimm presents a series of refactorings that, over time, encapsulates direct access to the database within the model layer, only exposing it to consumers via a well defined interface. Here, we will take a slightly different approach, and use our newly minted concept of privileged consumers to bestow access upon certain other objects.</p> <p>Imagine, further, if you will, an application with complex authorization requirements that cannot be simply defined in a single <code>Ability</code> class, a pattern popularized by the <span class="fancylink"> <a href="https://github.com/CanCanCommunity/cancancan">cancancan gem</a> <span> <a href="https://github.com/CanCanCommunity/cancancan" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>. Instead, we want to have a separate category of objects that mediate access to the underlying models. While we could simply decorate our models with objects that perform our unsafe operations, we want to be able to programmatically enforce this restriction.</p> <p>We will first need to discuss protected class methods. It may seem obvious that it is possible to protect a method by simply placing it after the <code>protected</code> call, but that is not so.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">Protected</span>
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">show</span>
    <span class="ss">:protected</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <figure class="highlight"><pre><code class="language-irb" data-lang="irb"><span></span><span class="gp">&gt;&gt; </span><span class="no">Protected</span><span class="o">.</span><span class="n">show</span>
<span class="go">=&gt; :protected</span></code></pre></figure> <p>Instead, we can make use of the fact that, in Ruby, a class is simply an instance of a <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/Class.html"><code>Class</code></a> <span> <a href="https://ruby-doc.org/core-2.5.0/Class.html" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>. Consequently, it too has a singleton class that is open for modification. The pattern for doing so inside the class definition is rather well known, namely the colloquial <code>class &lt;&lt; self</code> syntax. In fact, the name of the method responsible for programmatically generating class methods is <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/Object.html#method-i-define_singleton_method"><code>Object#define_singleton_method</code></a> <span> <a href="https://ruby-doc.org/core-2.5.0/Object.html#method-i-define_singleton_method" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>, a remnant of the days of yore (pre Ruby 1.9.1) when this pattern was necessary to metaprogram at the class level.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">Protected</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="kp">protected</span>

    <span class="k">def</span> <span class="nf">show</span>
      <span class="ss">:protected</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <figure class="highlight"><pre><code class="language-irb" data-lang="irb"><span></span><span class="gp">&gt;&gt; </span><span class="no">Protected</span><span class="o">.</span><span class="n">show</span>
<span class="go">Traceback (most recent call last):</span>
<span class="go">        2: from /home/sonny/.rbenv/versions/2.5.0/bin/irb:11:in `&lt;main&gt;&#39;</span>
<span class="go">        1: from (irb):11</span>
<span class="go">NoMethodError (protected method `show&#39; called for Protected:Class)</span></code></pre></figure> <p>With this in hand, the first step toward protecting the query interface of our objects will be to create a <code>Redactor</code> module that simply takes a class name and a list of methods to hide from the outside world via use of the <code>protected</code> method on the singleton class.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Redactor</span>
  <span class="k">def</span> <span class="nf">redact!</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="nb">methods</span><span class="p">)</span>
    <span class="n">klass</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
      <span class="nb">methods</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="nb">method</span><span class="o">|</span> <span class="kp">protected</span> <span class="nb">method</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>This module simply opens the singleton class of the class on which we want to redact the methods, and, using <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/Module.html#method-i-class_eval"><code>Module#class_eval</code></a> <span> <a href="https://ruby-doc.org/core-2.5.0/Module.html#method-i-class_eval" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>, marks each method as protected. The next piece of the puzzle is to define our mediators, starting with the <code>BaseMediator</code>, which ensapsulate all the complexity of redacting methods and refining them within the context of the appropriate subclasses.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">BaseMediator</span>
  <span class="kp">extend</span> <span class="no">Redactor</span>

  <span class="c1"># http://guides.rubyonrails.org/active_record_querying.html#retrieving-objects-from-the-database</span>
  <span class="no">QUERY_INTERFACE_METHODS</span> <span class="o">=</span> <span class="o">%</span><span class="n">i</span><span class="p">(</span>
    <span class="n">find</span>
    <span class="n">create_with</span>
    <span class="n">distinct</span>
    <span class="n">eager_load</span>
    <span class="n">extending</span>
    <span class="n">from</span>
    <span class="n">group</span>
    <span class="n">having</span>
    <span class="n">includes</span>
    <span class="n">joins</span>
    <span class="n">left_outer_joins</span>
    <span class="n">limit</span>
    <span class="n">lock</span>
    <span class="n">none</span>
    <span class="n">offset</span>
    <span class="n">order</span>
    <span class="n">preload</span>
    <span class="n">readonly</span>
    <span class="n">references</span>
    <span class="n">reorder</span>
    <span class="nb">select</span>
    <span class="n">where</span>
  <span class="p">)</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">redact_and_refine!</span><span class="p">(</span><span class="n">subclass</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">subclass</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/Mediator$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_constantize</span>

    <span class="n">redact!</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="no">QUERY_INTERFACE_METHODS</span><span class="p">)</span>

    <span class="no">Module</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="n">refine</span> <span class="n">model</span><span class="o">.</span><span class="n">singleton_class</span> <span class="k">do</span>
        <span class="no">QUERY_INTERFACE_METHODS</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="nb">method</span><span class="o">|</span> <span class="kp">public</span> <span class="nb">method</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>The <code>redact_and_refine!</code> class macro has two primary responsibilities, as indicated by its name:</p> <ol> <li> Redact the methods we do not want to have exposed.</li> <li> Create a module with a refinement that makes them public again.</li> </ol> <p>Normally, we would want to simplify this for the subclass by using <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/Class.html#method-i-inherited"><code>Class::inherited</code></a> <span> <a href="https://ruby-doc.org/core-2.5.0/Class.html#method-i-inherited" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>, but, in this case, we are unable to do so, since trying to call <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/Module.html#method-i-using"><code>Module::using</code></a> <span> <a href="https://ruby-doc.org/core-2.5.0/Module.html#method-i-using" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span> from within a method results in the following error: <code>RuntimeError: Module#using is not permitted in methods</code>. We are, therefore, forced to have each subclass pull in its own refinement, such as in the following <code>CustomerMediator</code> below.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">CustomerMediator</span> <span class="o">&lt;</span> <span class="no">BaseMediator</span>
  <span class="n">using</span> <span class="n">redact_and_refine!</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">load</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="no">Customer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>While not ideal, this is not an onerous task for significantly increased safety. Because the <code>CustomerMediator</code> is responsible for hiding the methods inside the <code>Customer</code> model from the outside world, we must first load it. Then, using that same class, we are able to access the <code>Customer::find</code> method, but when we try to do so directly, we are greeted by a <code>NoMethodError</code> remarking that the method is protected.</p> <figure class="highlight"><pre><code class="language-irb" data-lang="irb"><span></span><span class="gp">&gt;&gt; </span><span class="no">CustomerMediator</span>
<span class="go">=&gt; CustomerMediator</span>

<span class="gp">&gt;&gt; </span><span class="no">CustomerMediator</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">   Customer Load (0.3ms)  SELECT  &quot;customers&quot;.* FROM &quot;customers&quot; WHERE &quot;customers&quot;.&quot;id&quot; = $1 LIMIT $2  [[&quot;id&quot;, 1], [&quot;LIMIT&quot;, 1]]</span>
<span class="go">=&gt; #&lt;Customer:0x0000559d5f12a4d8 id: 1&gt;</span>

<span class="gp">&gt;&gt; </span><span class="no">Customer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">NoMethodError: protected method `find&#39; called for Customer(id: integer):Class</span></code></pre></figure> <h2>The Wall of Least Surprise</h2> <p>In a perfect world, we would want to provide a better error message for consumers of our classes, rather than the generic default message. This desire to provide the developer with as easy an interface as possible is an example of the <span class="fancylink"> <a href="https://en.wikipedia.org/wiki/Principle_of_least_astonishment">principle of least surprise</a> <span> <a href="https://en.wikipedia.org/wiki/Principle_of_least_astonishment" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>. Attempts to add this feature, however, are not forthcoming, because of the dynamic dispatch semantics of Ruby. Take, for instance, the following modification on the existing <code>Redactor</code> module and <code>BaseMediator</code> class:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Redactor</span>
  <span class="k">def</span> <span class="nf">redact!</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="nb">methods</span><span class="p">)</span>
    <span class="nb">methods</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="nb">method</span><span class="o">|</span>
      <span class="n">redacted_method</span> <span class="o">=</span> <span class="s2">&quot;__</span><span class="si">#{</span><span class="nb">method</span><span class="si">}</span><span class="s2">_redacted&quot;</span><span class="o">.</span><span class="n">to_sym</span>

      <span class="n">klass</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
        <span class="n">alias_method</span><span class="p">(</span><span class="n">redacted_method</span><span class="p">,</span> <span class="nb">method</span><span class="p">)</span>
        <span class="kp">protected</span> <span class="n">redacted_method</span>
      <span class="k">end</span>

      <span class="n">klass</span><span class="o">.</span><span class="n">define_singleton_method</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="o">|</span>
        <span class="k">begin</span>
          <span class="n">public_send</span><span class="p">(</span><span class="n">redacted_method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">rescue</span> <span class="no">NoMethodError</span> <span class="o">=&gt;</span> <span class="n">e</span>
          <span class="k">raise</span> <span class="n">e</span> <span class="k">unless</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span> <span class="o">=~</span> <span class="sr">%r{^protected method `</span><span class="si">#{</span><span class="n">redacted_method</span><span class="si">}</span><span class="sr">&#39; called for </span><span class="si">#{</span><span class="n">klass</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="sr">}</span>
          <span class="k">raise</span> <span class="no">SecurityError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">klass</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> cannot be queried directly, please use </span><span class="si">#{</span><span class="n">klass</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">Mediator&quot;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">redacted_method</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">BaseMediator</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">redact_and_refine!</span><span class="p">(</span><span class="n">subclass</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">subclass</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/Mediator$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_constantize</span>

    <span class="n">redacted_methods</span> <span class="o">=</span> <span class="n">redact!</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="no">QUERY_INTERFACE_METHODS</span><span class="p">)</span>

    <span class="no">Module</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="n">refine</span> <span class="n">model</span><span class="o">.</span><span class="n">singleton_class</span> <span class="k">do</span>
        <span class="n">redacted_methods</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="nb">method</span><span class="o">|</span> <span class="kp">public</span> <span class="nb">method</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>The major difference here is that we alias the existing method we are redacting and redefine the original method to wrap a call to the alias, catching the default exception and raising a more helpful one. The <code>BaseMediator</code> then makes the new methods public, rather than the original, which is already a public wrapper. Where this fails is that we have no way to call the original method while respecting its updated visibility. The use of <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/Object.html#method-i-public_send"><code>Object#public_send</code></a> <span> <a href="https://ruby-doc.org/core-2.5.0/Object.html#method-i-public_send" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span> fails, since it does not honor the refinement and believes that that method is still protected, as can be seen in the following.</p> <figure class="highlight"><pre><code class="language-irb" data-lang="irb"><span></span><span class="gp">&gt;&gt; </span><span class="no">CustomerFinder</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">SecurityError: Customer cannot be queried directly, please use CustomerMediator</span></code></pre></figure> <p>Attempting to use either <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/Object.html#method-i-send"><code>Object#send</code></a> <span> <a href="https://ruby-doc.org/core-2.5.0/Object.html#method-i-send" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span> or <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/Object.html#method-i-send"><code>Object#method</code></a> <span> <a href="https://ruby-doc.org/core-2.5.0/Object.html#method-i-send" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span> to call the method directly both fail by ignoring the visibility rules altogether. As such, we cannot provide a better message by wrapping the call to our redacted method with some exception handling.</p> <p>Another approach worthy of attempt is to inspect, via <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/Object.html#method-i-public_methods"><code>Object#public_methods</code></a> <span> <a href="https://ruby-doc.org/core-2.5.0/Object.html#method-i-public_methods" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span> and <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/Object.html#method-i-protected_methods"><code>Object#protected_methods</code></a> <span> <a href="https://ruby-doc.org/core-2.5.0/Object.html#method-i-protected_methods" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>, which methods are available, but this also fails to produce the expected results. The following example leads us to a better understanding of what is happening behind the curtains when using refinements to modify method visibility.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">Protected</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="kp">protected</span>

    <span class="k">def</span> <span class="nf">print</span>
      <span class="ss">:protected</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">Publicize</span>
  <span class="n">refine</span> <span class="no">Protected</span><span class="o">.</span><span class="n">singleton_class</span> <span class="k">do</span>
    <span class="kp">public</span> <span class="ss">:print</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Public</span>
  <span class="n">using</span> <span class="no">Publicize</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">print</span>
    <span class="no">Protected</span><span class="o">.</span><span class="n">public_methods</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">:print</span><span class="p">)</span> <span class="c1"># false</span>
    <span class="no">Protected</span><span class="o">.</span><span class="n">protected_methods</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">:print</span><span class="p">)</span> <span class="c1"># true</span>

    <span class="no">Protected</span><span class="o">.</span><span class="n">print</span> <span class="c1"># works</span>
    <span class="no">Protected</span><span class="o">.</span><span class="n">public_send</span><span class="p">(</span><span class="ss">:print</span><span class="p">)</span> <span class="c1"># fails</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Public</span><span class="o">.</span><span class="n">print</span></code></pre></figure> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
        <span class="m">2</span>: from protection.rb:29:in <span class="sb">`</span>&lt;main&gt;<span class="s1">&#39;</span>
<span class="s1">        1: from protection.rb:25:in `print&#39;</span>
protection.rb:25:in <span class="sb">`</span>public_send<span class="s1">&#39;: protected method `print&#39;</span> called <span class="k">for</span> Protected:Class <span class="o">(</span>NoMethodError<span class="o">)</span></code></pre></figure> <p>When this script is run, the static call works, but the dynamic call fails. The <code>Protected::print</code> method, moreover, is list as protected, not public, from within the class using the refinement! As a consequence of this final result, I cannot recommend using refinements for modifying method visibility when there is any intention to use dynamic dispatch or rely upon reflection. Having encountered this first hand, it is worth pointing out that this is, at least indirectly, mentioned in the <span class="fancylink"> <a href="https://ruby-doc.org/core-2.5.0/doc/syntax/refinements_rdoc.html#label-Indirect+Method+Calls">documentation</a> <span> <a href="https://ruby-doc.org/core-2.5.0/doc/syntax/refinements_rdoc.html#label-Indirect+Method+Calls" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span> for refinements:</p> <blockquote> <p> When using indirect method access such as <code>Kernel#send</code>, <code>Kernel#method</code> or <code>Kernel#respond_to?</code> refinements are not honored for the caller context during method lookup. </p> <p> This behavior may be changed in the future. </p> </blockquote> <p>Since this leads to somewhat unexpected results, I have decided to start a conversation about changing this behavior, which can be found <span class="fancylink"> <a href="https://bugs.ruby-lang.org/issues/14252">here</a> <span> <a href="https://bugs.ruby-lang.org/issues/14252" target="_blank" alt="Pop Out" title="Pop Out"><svg class="octicon octicon-link-external" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M11 10h1v3c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h3v1H1v10h10v-3zM6 2l2.25 2.25L5 7.5 6.5 9l3.25-3.25L12 8V2H6z"/></svg></a> </span> </span>.</p> <span class="post-date">03 Jan 2018</span> </div> <div class="related"> <h2>Related Posts</h2> <ul class="related-posts"> <li> <h3> <a href="/2017/06/05/common-table-expressions-in-activerecord-a-case-study-of-quantiles/"> Common Table Expressions in ActiveRecord: A Case Study of Quantiles <small>05 Jun 2017</small> </a> </h3> </li> <li> <h3> <a href="/2017/06/18/on-maintainability-gold-plating-the-game-of-life-in-elm/"> On Maintainability: Gold Plating the Game of Life in Elm <small>18 Jun 2017</small> </a> </h3> </li> <li> <h3> <a href="/2018/11/19/types-in-elm-decomposition-and-ad-hoc-polymorphism/"> Types in Elm: Decomposition and Ad Hoc Polymorphism <small>19 Nov 2018</small> </a> </h3> </li> </ul> </div> <p class="bitcoin"></p> </div> <script>!function(e,n,t,a,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=n.createElement(t),s=n.getElementsByTagName(t)[0],o.async=1,o.src=a,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-47296801-1","sonnym.github.io"),ga("send","pageview");</script> </body> </html>